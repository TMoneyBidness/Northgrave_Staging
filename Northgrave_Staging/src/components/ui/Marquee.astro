---
interface LogoItem {
  src: string;
  alt: string;
}

interface Props {
  items: LogoItem[];
  speed?: number;
}

const { items, speed = 1 } = Astro.props;
---

<div class="logo-scroll" data-speed={speed}>
  <div class="logo-scroll__track">
    {items.map((item) => (
      <div class="logo-scroll__item">
        <img src={item.src} alt={item.alt} width="120" height="60" />
      </div>
    ))}
  </div>
  <div class="logo-scroll__track" aria-hidden="true">
    {items.map((item) => (
      <div class="logo-scroll__item">
        <img src={item.src} alt={item.alt} width="120" height="60" />
      </div>
    ))}
  </div>
</div>

<style>
  .logo-scroll {
    width: 100%;
    overflow: hidden;
    padding: 2rem 0;
    background: linear-gradient(180deg, transparent, rgba(5, 5, 9, 0.3), transparent);
    position: relative;
  }

  .logo-scroll::before,
  .logo-scroll::after {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100px;
    z-index: 2;
    pointer-events: none;
  }

  .logo-scroll::before {
    left: 0;
    background: linear-gradient(90deg, var(--color-night-deep, #0a0a0f), transparent);
  }

  .logo-scroll::after {
    right: 0;
    background: linear-gradient(-90deg, var(--color-night-deep, #0a0a0f), transparent);
  }

  .logo-scroll__track {
    display: inline-flex;
    gap: 4rem;
    padding: 0 2rem;
  }

  .logo-scroll__item {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .logo-scroll__item img {
    height: 60px;
    width: auto;
    max-width: 180px;
    object-fit: contain;
    opacity: 0.7;
    filter: grayscale(100%) brightness(1.3);
    transition: opacity 0.3s, filter 0.3s;
  }

  .logo-scroll:hover .logo-scroll__item img {
    opacity: 0.9;
  }

  @media (prefers-reduced-motion: reduce) {
    .logo-scroll__track {
      animation: none !important;
    }
  }
</style>

<script>
  class LogoScroller {
    private container: HTMLElement;
    private tracks: HTMLElement[];
    private position: number = 0;
    private speed: number;
    private trackWidth: number = 0;
    private animationId: number | null = null;
    private isHovered: boolean = false;

    constructor(container: HTMLElement) {
      this.container = container;
      this.tracks = Array.from(container.querySelectorAll('.logo-scroll__track'));
      this.speed = parseFloat(container.dataset.speed || '1');

      this.init();
    }

    private init() {
      // Wait for images to load
      const images = this.container.querySelectorAll('img');
      let loadedCount = 0;

      const checkReady = () => {
        loadedCount++;
        if (loadedCount >= images.length) {
          this.setup();
        }
      };

      images.forEach((img) => {
        if (img.complete) {
          checkReady();
        } else {
          img.addEventListener('load', checkReady);
          img.addEventListener('error', checkReady);
        }
      });

      // Fallback: start anyway after 2 seconds
      setTimeout(() => {
        if (!this.animationId) {
          this.setup();
        }
      }, 2000);
    }

    private setup() {
      if (this.tracks.length < 2) return;

      // Calculate track width
      this.trackWidth = this.tracks[0].offsetWidth;

      // Position tracks inline
      this.container.style.display = 'flex';
      this.container.style.width = '100%';

      // Add hover listeners
      this.container.addEventListener('mouseenter', () => {
        this.isHovered = true;
      });
      this.container.addEventListener('mouseleave', () => {
        this.isHovered = false;
      });

      // Start animation
      this.animate();
    }

    private animate = () => {
      if (!this.isHovered) {
        this.position -= this.speed;

        // Reset position when first track is fully scrolled
        if (Math.abs(this.position) >= this.trackWidth) {
          this.position = 0;
        }

        this.tracks.forEach((track) => {
          track.style.transform = `translateX(${this.position}px)`;
        });
      }

      this.animationId = requestAnimationFrame(this.animate);
    };
  }

  // Initialize all scrollers
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.logo-scroll').forEach((el) => {
      new LogoScroller(el as HTMLElement);
    });
  });

  // Also try on astro:page-load for view transitions
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.logo-scroll').forEach((el) => {
      if (!(el as any)._scroller) {
        (el as any)._scroller = new LogoScroller(el as HTMLElement);
      }
    });
  });
</script>
